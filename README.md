## OTP Routing

This is a Docker container designed to calculate large-scale distance matrices for groups of Census tracts or blocks. It uses counties as a unit of work, taking a county FIPS code and the files generated by [otp-resources](https://github.com/dfsnow/otp-resources) as inputs and saving outputs to `/resources/outputs/$GEOID/` inside the container (where $GEOID is the FIPS code of the county).

### Inputs
The container takes the following inputs as Docker environmental variables, all arguments are required:

- GEOID (the five-digit, 2010 FIPS code for a U.S. county)
- TRAVEL_MODE (the type of travel mode within OTP, can be 'CAR', 'TRANSIT,WALK', or 'WALK') 
- MAX_TRAVEL_TIME (the maximum travel time before cutoff, in seconds) 
- MAX_WALK_DIST (the maximum walking distance before cutoff, in meters)
- CHUNKS (the number of chunks to divide the input file into, keep high for blocks and low for tracts)
- MAX_THREADS (the maximum number of threads to process jobs with)

Each OTP matrix calculation requires 4 input files: a PBF of the relevant area, a CSV of origin locations, a CSV of destination locations, and zip file of any GTFS feeds in the buffered county.

The container will look for these input files in `/resources/graphs/$GEOID`. It will ingest the files exactly as they are outputted by [otp-resources](https://github.com/dfsnow/otp-resources), simply mount the same `/resources/graphs/` for both containers. An example of this setup is provided in `submit_jobs.sh`.

### Outputs
This container outputs a CSV distance matrix that is n * m long and 3 wide, where n is the number of origins and m is the number of destinations. Sample output:

```
origin,destination,minutes
17031010100,17031010201,19.37
17031010100,17031010202,10.35
17031010100,17031010300,10.77
17031010100,17031010400,13.33
17031010100,17031010501,11.03
17031010100,17031010502,13.95
17031010100,17031010503,16.35
17031010100,17031010600,18.35
```

Each CSV is bzip'd to save space (some block matrices can be very large). Output files are saved to `/resources/outputs/$GEOID/`, and each output file is named according to its $GEOID and $TRANSIT_MODE. 

### Notes
This container can also ingest the zipped tarballs created by [otp-resources](https://github.com/dfsnow/otp-resources). If the container does not find the necessary input files in `/resources/graphs/$GEOID/`, it will look for a tarball in `/resources/zipped/` and then unzip it to the appropriate directory. 

